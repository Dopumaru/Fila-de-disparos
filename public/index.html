<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Painel de Disparos</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 980px; margin: 26px auto; padding: 0 14px; }
    h2 { margin: 0 0 14px; }
    label { display:block; margin-top: 12px; font-weight: 600; }
    textarea, input, select { width: 100%; padding: 10px; box-sizing: border-box; }
    textarea { resize: vertical; min-height: 120px; }
    .hint { color:#555; font-size: 12px; margin-top: 6px; }
    .row { display:flex; gap:12px; align-items: flex-end; }
    .row > div { flex:1; }
    button { margin-top: 14px; padding: 12px; width: 100%; cursor: pointer; font-weight: 700; }
    button:disabled { opacity: .65; cursor: not-allowed; }
    pre { background:#f5f5f5; padding: 12px; overflow:auto; border-radius: 8px; border: 1px solid #eee; }
    .ok { color: #0a7a2f; }
    .err { color: #b00020; }
    .warn { color: #8a5a00; }
    .pill { display:inline-block; padding: 6px 10px; border-radius: 999px; background:#eee; margin-right: 6px; margin-top: 6px; }
    .tokens { display:flex; gap:8px; flex-wrap: wrap; margin-top: 8px; }
    .tokenBtn { border:1px solid #ddd; background:#fff; padding: 8px 10px; border-radius: 10px; cursor:pointer; }
    .tokenBtn.active { border-color: #333; }
    .muted { color:#666; font-size: 12px; }
    .mediaBox { background:#fafafa; padding:14px; border-radius:10px; border:1px solid #eee; margin-top:10px; }
    .box { background:#fafafa; padding:14px; border-radius:10px; border:1px solid #eee; margin-top:10px; }
  </style>
</head>
<body>
  <h2>Painel de Disparos</h2>

  <hr>

  <label>Token do Bot</label>
  <input id="tokenInput" placeholder="Cole o BOT TOKEN aqui (não é salvo)" />
  <div class="hint">Nunca compartilhe seu token.</div>

  <div class="row">
    <div><button id="btnAddToken" type="button">Adicionar token</button></div>
    <div><button id="btnRemoveToken" type="button">Remover token selecionado</button></div>
  </div>

  <div id="tokensArea" class="tokens"></div>
  <div class="muted">Token selecionado é usado no disparo.</div>

  <hr>

  <div class="row">
    <div>
      <label>Tipo</label>
      <select id="tipo">
        <option value="text">Texto</option>
        <option value="photo">Foto</option>
        <option value="video">Vídeo</option>
        <option value="video_note">Vídeo redondo</option>
        <option value="voice">Voz</option>
        <option value="audio">Áudio</option>
        <option value="document">Documento</option>
      </select>
    </div>
  </div>

  <div id="mediaBlock" class="mediaBox">
    <label>Arquivo (Upload)</label>
    <input id="arquivo" type="file" />
    <div class="hint">Use upload para arquivos menores.</div>

    <label>OU URL do Arquivo</label>
    <input id="fileUrl" placeholder="https://..." />
    <div class="hint">
      ⚠️ Preencha <b>URL</b> OU selecione <b>Upload</b> (não os dois).
    </div>
  </div>

  <label>Mensagem / Legenda (suporta {variáveis})</label>
  <textarea id="mensagem"></textarea>

  <hr>

  <label>CSV de leads (obrigatório)</label>
  <div class="row">
    <div>
      <input id="csvFile" type="file" accept=".csv,text/csv" />
    </div>
    <div style="max-width:220px;">
      <label>Coluna do ID</label>
      <input id="idColumn" value="chatId" />
    </div>
  </div>

  <!-- LIMITES AJUSTADOS PARA 25 -->
  <div class="row">
    <div>
      <label>Limite por intervalo</label>
      <input id="limitMax" type="number" value="1" min="1" max="25" step="1" />
      <div class="hint">
        Máximo permitido no painel: <b>25</b>.<br>
        ⚠️ Valores acima de 10/s podem gerar <b>429 Too Many Requests</b>.
      </div>
    </div>
    <div>
      <label>Intervalo (ms)</label>
      <input id="limitMs" type="number" value="1000" min="200" max="60000" step="50" />
      <div class="hint">
        1000ms = ~1 msg/s.<br>
        Exemplo agressivo: 25 / 1000ms = 25 msg/s.
      </div>
    </div>
  </div>

  <div id="rateWarn" class="hint warn" style="display:none; margin-top:8px;">
    ⚠️ Configuração agressiva detectada. Alto risco de 429 (flood control).
  </div>

  <button id="btnEnviar" type="button">Enviar campanha</button>

  <p id="status"></p>
  <pre id="debug"></pre>

  <script>
    const tipo = document.getElementById("tipo");
    const mediaBlock = document.getElementById("mediaBlock");

    function refreshUI() {
      mediaBlock.style.display = (tipo.value === "text") ? "none" : "block";
    }
    tipo.addEventListener("change", refreshUI);
    refreshUI();
  </script>

  <!-- VALIDAÇÃO DE TAXA -->
  <script>
    const limitMaxEl = document.getElementById("limitMax");
    const limitMsEl = document.getElementById("limitMs");
    const rateWarnEl = document.getElementById("rateWarn");

    function clampInt(v, min, max, fallback) {
      const n = Number(v);
      if (!Number.isFinite(n)) return fallback;
      return Math.min(max, Math.max(min, Math.trunc(n)));
    }

    function clampMs(v) {
      const n = Number(v);
      if (!Number.isFinite(n)) return 1000;
      return Math.min(60000, Math.max(200, Math.round(n)));
    }

    function refreshRateWarn() {
      const max = clampInt(limitMaxEl.value, 1, 25, 1);
      const ms = clampMs(limitMsEl.value);

      limitMaxEl.value = String(max);
      limitMsEl.value = String(ms);

      const perSecond = (max / ms) * 1000;

      if (perSecond > 10) {
        rateWarnEl.style.display = "block";
      } else {
        rateWarnEl.style.display = "none";
      }
    }

    limitMaxEl.addEventListener("input", refreshRateWarn);
    limitMsEl.addEventListener("input", refreshRateWarn);
    refreshRateWarn();
  </script>

  <script src="./app.js"></script>
</body>
</html>
